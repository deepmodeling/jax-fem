
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Shape optimization &#8212; JAX-FEM 0.0.10 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=972fa7a7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=94452c26"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'learn/shape_optimization/example';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Structure/material co-design" href="../structure_material_co_design/example.html" />
    <link rel="prev" title="Thermal mechanical control" href="../thermal_mechanical_control/example.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="JAX-FEM 0.0.10 documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="JAX-FEM 0.0.10 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">User guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../guide/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/Quickstart.html">Quickstart</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Learn by examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../poisson/example.html">Poisson equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_elasticity/example.html">Linear elasticity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hyperelasticity/example.html">Hyperelasticity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plasticity/example.html">Plasticity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compute_gradients/example.html">Compute gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topology_optimization/example.html">Topology optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source_field_identification/example.html">Source field identification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../traction_force_identification/example.html">Traction force identification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thermal_mechanical_control/example.html">Thermal mechanical control</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Shape optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../structure_material_co_design/example.html">Structure/material co-design</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../advanced/adv_main.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">More resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../more/FAQ.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/useful/main.html">Useful links</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../more/api/api_main.html">API reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_fe.html">jax_fem.fe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_problem.html">jax_fem.problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_basis.html">jax_fem.basis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_solver.html">jax_fem.solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_mma.html">jax_fem.mma</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_generate_mesh.html">jax_fem.generate_mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../more/api/api_utils.html">jax_fem.utils</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/log.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/citation.html">Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/project.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/contact.html">Contact</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/deepmodeling/jax-fem" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/learn/shape_optimization/example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Shape optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Problem-definition">Problem definition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Domain-and-boundary-conditions">Domain and boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Weak-form">Weak form</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Optimization-problem">Optimization problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Weak form</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Mesh">Mesh</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Boundary-conditions">Boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Problem">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Solver">Solver</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadLinks = document.querySelectorAll('a.reference.download.internal');
    downloadLinks.forEach(link => {
        link.setAttribute('download', '');
        link.href = '../_sources/' + link.getAttribute('href');
    });
});
</script><section id="Shape-optimization">
<h1>Shape optimization<a class="headerlink" href="#Shape-optimization" title="Link to this heading">#</a></h1>
<section id="Problem-definition">
<h2>Problem definition<a class="headerlink" href="#Problem-definition" title="Link to this heading">#</a></h2>
<p>In this example, an inverse problem is considered. The design parameter is a stiffness related term. The target of this tutorial is to use JAX-FEM to automatically find the gradient of the objective function with respect to this design variable.</p>
<p>A structural shape optimization problem will be illustrated here. A 2D cantilever beam contains eight square holes and is fixed at the left boundary (<span class="math notranslate nohighlight">\(\Gamma_D\)</span>). A shear force <span class="math notranslate nohighlight">\(\boldsymbol{t}\)</span> is applied near the bottom-right boundary (<span class="math notranslate nohighlight">\(\Gamma_N\)</span>). Manufacturing constraints permit the rotation of the eight holes, and the goal is to <strong>minimize the compliance</strong> of the beam under the applied shear force.</p>
<p>The design parameters <span class="math notranslate nohighlight">\(\boldsymbol{\theta} = [\theta_1, \theta_2, \dots, \theta_M] \in \mathbb{R}^M\)</span> with <span class="math notranslate nohighlight">\(M=8\)</span> represent the <strong>rotation angles</strong> of the eight holes. The mapping from <span class="math notranslate nohighlight">\(\boldsymbol{\theta}\)</span> to the density field <span class="math notranslate nohighlight">\(\rho(\boldsymbol{x})\)</span> commonly used in topology optimization uses a <strong>sigmoid function</strong> to ensure smoothness and differentiability. The material model follows the hyperelasticity formulation introduced in the previous example (<a class="reference external" href="https://deepmodeling.github.io/jax-fem/learn/traction_force_identification/example.html">traction force
identification</a>).</p>
<img alt="Shape Optimization" src="../../_images/shape_optimization.png" />
<p>The static equilibrium for the hyperelastic material follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
-\nabla \cdot \boldsymbol{P} &amp;= \boldsymbol{0}  \quad \text{in}  \quad \Omega, \\
\boldsymbol{u} &amp;= \boldsymbol{0}  \quad \text{on}  \quad \Gamma_D, \\
\boldsymbol{P} \cdot \boldsymbol{n} &amp;= \boldsymbol{t}  \quad \text{on}  \quad \Gamma_N,
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{P}\)</span> is the first Piola–Kirchhoff stress tensor derived from a neo-Hookean strain energy density function <span class="math notranslate nohighlight">\(W\)</span>.</p>
<section id="Domain-and-boundary-conditions">
<h3>Domain and boundary conditions<a class="headerlink" href="#Domain-and-boundary-conditions" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Omega \subset \mathbb{R}^2\)</span> (2D cantilever beam with eight square holes)</p></li>
<li><p><span class="math notranslate nohighlight">\(\Gamma_D = \left\{ \boldsymbol{x} \in \partial \Omega \mid x_1 = 0 \right\}\)</span> (Dirichlet boundary: fixed left side)</p></li>
<li><p><span class="math notranslate nohighlight">\(\Gamma_N \subset \left\{ \boldsymbol{x} \in \partial \Omega \mid x_1 = L \right\}\)</span> (Neumann boundary: right side, near the bottom)</p></li>
</ul>
</section>
<section id="Weak-form">
<h3>Weak form<a class="headerlink" href="#Weak-form" title="Link to this heading">#</a></h3>
<p>Find <span class="math notranslate nohighlight">\(\boldsymbol{u}\)</span> such that for all test functions <span class="math notranslate nohighlight">\(\boldsymbol{v}\)</span>,</p>
<div class="math notranslate nohighlight">
\[r(\boldsymbol{u}; \boldsymbol{v}) = \int_{\Omega} \boldsymbol{P} : \nabla \boldsymbol{v}  \mathrm{d}\Omega - \int_{\Gamma_N} \boldsymbol{t} \cdot \boldsymbol{v}  \mathrm{d}\Gamma = 0.\]</div>
</section>
<section id="Optimization-problem">
<h3>Optimization problem<a class="headerlink" href="#Optimization-problem" title="Link to this heading">#</a></h3>
<p>The inverse shape optimization subject to the PDE constraint:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\min_{\boldsymbol{\theta}} \quad &amp; \int_{\Gamma_N} \boldsymbol{t} \cdot \boldsymbol{u}  \mathrm{d} \Gamma \\
\text{s.t.} \quad &amp; r(\boldsymbol{u}; \boldsymbol{v}) = 0,
\end{aligned}\end{split}\]</div>
<p>which minimizes the compliance while rotating holes to alter the stiffness distribution.</p>
</section>
</section>
<section id="Implementation">
<h2>Implementation<a class="headerlink" href="#Implementation" title="Link to this heading">#</a></h2>
<p>For the implementation, we first import some necessary modules.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">onp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">meshio</span>

<span class="c1"># Import JAX-FEM specific modules.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax_fem.problem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Problem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax_fem.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">ad_wrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax_fem.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_sol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax_fem.generate_mesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_meshio_cell_type</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">rectangle_mesh</span>
</pre></div>
</div>
</div>
<section id="id1">
<h3>Weak form<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>The definition of the hyperelasticity problem is shown as follows. The code is similar to the one used in the example of traction force identification, but with different internal variables settings for a different optimizaiton problem. Here, we are using the rotation angles of the eight square holes in the structure as the design parameters.</p>
<p>To define the square holes with polar coordinates, we first define a sigmoid function to map the input variables into the range of the rotation angles.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">scaled_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lower_lim</span> <span class="o">+</span> <span class="p">(</span><span class="n">upper_lim</span> <span class="o">-</span> <span class="n">lower_lim</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">p</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<p>With the rotation angles computed, we can use another sigmoid function to dig the rotated square holes in our design domain and return the density field. We use <code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code> to vectorized the computation process in the dimension of number of holes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pore_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pore_center</span><span class="p">,</span> <span class="n">L0</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">scaled_sigmoid</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">porosity</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pore_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pore_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pore_center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">x_rel</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">y_rel</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">200.</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_rel</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_rel</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">L0</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rho</span>
<span class="n">pore_fn_vmap</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">pore_fn</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>In order to define the holes in the design domain, we prepare the necessary information of the central points and intergral points in all the cells with the method <code class="docutils literal notranslate"><span class="pre">custom_init</span></code>. These will be done when the <code class="docutils literal notranslate"><span class="pre">problem</span></code> instance be initiated. Noted that we have four additional input arguments in <code class="docutils literal notranslate"><span class="pre">custom_init</span></code>. We will descride how this can be realized in the following problem definition part.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Elasticity</span><span class="p">(</span><span class="n">Problem</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">custom_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># (num_cells, num_quads, dim)</span>
        <span class="n">physical_quad_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">get_physical_quad_points</span><span class="p">()</span>
        <span class="n">L0</span> <span class="o">=</span> <span class="n">Lx</span><span class="o">/</span><span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pore_center_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quad_inds_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="n">pore_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">L0</span> <span class="o">+</span> <span class="n">L0</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">L0</span> <span class="o">+</span> <span class="n">L0</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pore_center_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pore_center</span><span class="p">)</span>
                <span class="c1"># (num_selected_quad_points, 2)</span>
                <span class="n">quad_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">physical_quad_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="o">*</span><span class="n">L0</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">physical_quad_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">L0</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">physical_quad_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="o">*</span><span class="n">L0</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">physical_quad_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">L0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quad_inds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quad_inds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L0</span> <span class="o">=</span> <span class="n">L0</span>
</pre></div>
</div>
</div>
<p>Then follows the definition of the weak form of a 2D plane strain hyperelasticity problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tensor_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">psi</span><span class="p">(</span><span class="n">F_2d</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
            <span class="c1"># Plane strain</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">F_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">F_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">F_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">F_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">],</span>
                            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="mf">1e6</span>
            <span class="n">Emin</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">*</span><span class="n">Emax</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">Emin</span> <span class="o">+</span> <span class="p">(</span><span class="n">Emax</span> <span class="o">-</span> <span class="n">Emin</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">nu</span><span class="p">))</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nu</span><span class="p">))</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">Jinv</span> <span class="o">=</span> <span class="n">J</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
            <span class="n">I1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">F</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Jinv</span><span class="o">*</span><span class="n">I1</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">kappa</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
            <span class="k">return</span> <span class="n">energy</span>
        <span class="n">P_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">first_PK_stress</span><span class="p">(</span><span class="n">u_grad</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">u_grad</span> <span class="o">+</span> <span class="n">I</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P_fn</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">P</span>
        <span class="k">return</span> <span class="n">first_PK_stress</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_surface_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">surface_map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">surface_map</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Here we comes to the most critical part of this tutorial about how to use some stiffness related terms as design parameters. In the method <code class="docutils literal notranslate"><span class="pre">set_params</span></code>, We input the rotation angles of the eight holes with the argument <code class="docutils literal notranslate"><span class="pre">params</span></code> and compute the density field based on it with the functions we formerly defined.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c1"># Override base class method.</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">rhos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">num_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">num_quads</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pore_center_list</span><span class="p">)):</span>
            <span class="n">quad_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_inds_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># (num_selected_quad_points, dim)</span>
            <span class="n">quad_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_quad_points</span><span class="p">[</span><span class="n">quad_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">quad_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">pore_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pore_center_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rho_vals</span> <span class="o">=</span> <span class="n">pore_fn_vmap</span><span class="p">(</span><span class="n">quad_points</span><span class="p">,</span> <span class="n">pore_center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L0</span><span class="p">,</span> <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">rhos</span> <span class="o">=</span> <span class="n">rhos</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">quad_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">quad_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rho_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhos</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Then follows the definition of our objective funtion, which is the compliance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_compliance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sol</span><span class="p">):</span>
        <span class="c1"># Surface integral</span>
        <span class="n">boundary_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_inds_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nanson_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">get_face_shape_grads</span><span class="p">(</span><span class="n">boundary_inds</span><span class="p">)</span>
        <span class="c1"># (num_selected_faces, 1, num_nodes, vec) * # (num_selected_faces, num_face_quads, num_nodes, 1)</span>
        <span class="n">u_face</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">cells</span><span class="p">][</span><span class="n">boundary_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe</span><span class="o">.</span><span class="n">face_shape_vals</span><span class="p">[</span><span class="n">boundary_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">u_face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u_face</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># (num_selected_faces, num_face_quads, vec)</span>
        <span class="c1"># (num_selected_faces, num_face_quads, dim)</span>
        <span class="n">subset_quad_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_surface_quad_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neumann_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_maps</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">traction</span> <span class="o">=</span> <span class="o">-</span><span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">neumann_fn</span><span class="p">))(</span><span class="n">u_face</span><span class="p">,</span> <span class="n">subset_quad_points</span><span class="p">)</span> <span class="c1"># (num_selected_faces, num_face_quads, vec)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">traction</span> <span class="o">*</span> <span class="n">u_face</span> <span class="o">*</span> <span class="n">nanson_scale</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
</div>
</section>
<section id="Mesh">
<h3>Mesh<a class="headerlink" href="#Mesh" title="Link to this heading">#</a></h3>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">QUAD4</span></code> element to discretize the computational domain.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ele_type</span> <span class="o">=</span> <span class="s1">&#39;QUAD4&#39;</span>
<span class="n">cell_type</span> <span class="o">=</span> <span class="n">get_meshio_cell_type</span><span class="p">(</span><span class="n">ele_type</span><span class="p">)</span>
<span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span>
<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="c1"># pore numbers along x-axis and y-axis</span>
<span class="n">meshio_mesh</span> <span class="o">=</span> <span class="n">rectangle_mesh</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">domain_x</span><span class="o">=</span><span class="n">Lx</span><span class="p">,</span> <span class="n">domain_y</span><span class="o">=</span><span class="n">Ly</span><span class="p">)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">meshio_mesh</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">meshio_mesh</span><span class="o">.</span><span class="n">cells_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Boundary-conditions">
<h3>Boundary conditions<a class="headerlink" href="#Boundary-conditions" title="Link to this heading">#</a></h3>
<p>Then we can define the Dirichlet boundary condition and the location of the Neumann boundary condtion.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fixed_location</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_location</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">Ly</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dirichlet_val</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.</span>

<span class="n">dirichlet_bc_info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fixed_location</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">dirichlet_val</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>

<span class="n">location_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_location</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Problem">
<h3>Problem<a class="headerlink" href="#Problem" title="Link to this heading">#</a></h3>
<p>We have completed all the preliminary preparations for the problem. So, we can proceed to create an instance of our problem. Here we are adding some <code class="docutils literal notranslate"><span class="pre">additional_info</span></code>, which are the sizes of our design domain and the pore numbers along the two spacial axis, to the instance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">problem</span> <span class="o">=</span> <span class="n">Elasticity</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ele_type</span><span class="o">=</span><span class="n">ele_type</span><span class="p">,</span> <span class="n">dirichlet_bc_info</span><span class="o">=</span><span class="n">dirichlet_bc_info</span><span class="p">,</span>
                     <span class="n">location_fns</span><span class="o">=</span><span class="n">location_fns</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Solver">
<h3>Solver<a class="headerlink" href="#Solver" title="Link to this heading">#</a></h3>
<p>Then we can wrap the forward problem with the function <code class="docutils literal notranslate"><span class="pre">ad_wrapper</span></code>, which enables efficient gradient computation for our inverse problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fwd_pred</span> <span class="o">=</span> <span class="n">ad_wrapper</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;umfpack_solver&#39;</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">adjoint_solver_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;umfpack_solver&#39;</span><span class="p">:</span> <span class="p">{}})</span>
</pre></div>
</div>
</div>
<p>Then follows the definition of our objective funtion.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">J</span><span class="p">(</span><span class="n">θ</span><span class="p">):</span>
    <span class="n">sol_list</span> <span class="o">=</span> <span class="n">fwd_pred</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span>
    <span class="n">compliace</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">compute_compliance</span><span class="p">(</span><span class="n">sol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">compliace</span>
</pre></div>
</div>
</div>
<p>To verify the accuracy of gradients computed using <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code>, we employ the finite difference method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">θ_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]</span><span class="o">*</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="p">)</span>
<span class="n">grad_value</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">J</span><span class="p">)(</span><span class="n">θ_ini</span><span class="p">)</span>

<span class="n">h</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">θ_plus</span> <span class="o">=</span> <span class="n">θ_ini</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">θ_ini</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">θ_minus</span> <span class="o">=</span> <span class="n">θ_ini</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">θ_ini</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">dx_fd_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">J</span><span class="p">(</span><span class="n">θ_plus</span><span class="p">)</span> <span class="o">-</span> <span class="n">J</span><span class="p">(</span><span class="n">θ_minus</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">θ_ini</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> grad_value[0] = </span><span class="si">{</span><span class="n">grad_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, dx_fd_0 = </span><span class="si">{</span><span class="n">dx_fd_0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The computation results are shown as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grad_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.036371384648253284</span><span class="p">,</span> <span class="n">dx_fd_0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.03637138590661948</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>Please refer to this <a class="reference external" href="https://github.com/deepmodeling/jax-fem/blob/main/docs/source/learn/shape_optimization/example.ipynb">link</a> to download the source file.</p>
</div></blockquote>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../thermal_mechanical_control/example.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Thermal mechanical control</p>
      </div>
    </a>
    <a class="right-next"
       href="../structure_material_co_design/example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Structure/material co-design</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Problem-definition">Problem definition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Domain-and-boundary-conditions">Domain and boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Weak-form">Weak form</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Optimization-problem">Optimization problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Weak form</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Mesh">Mesh</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Boundary-conditions">Boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Problem">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Solver">Solver</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By JAX-FEM team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, JAX-FEM team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>